<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grim Resolver</title>
    <script src="js/appData.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body x-data="appData()" x-init="init()">
    <div class="header">
        <h1>Grim Resolver</h1>

        <!-- Moved Navigation Tabs Inside Header -->
        <div class="view-tabs-header">
            <button @click="currentView = 'models'" :class="{'active': currentView === 'models'}">Model Editor</button>
            <button @click="currentView = 'scenarios'" :class="{'active': currentView === 'scenarios'}">Scenario Editor</button>
            <button @click="currentView = 'armory'" :class="{'active': currentView === 'armory'}">Armory Items</button>
        </div>

        <div class="header-buttons">
            <button class="export-btn" @click="exportModels">Export Models</button>
            <label class="import-btn" for="importInput">Import Models</label>
            <input type="file" id="importInput" accept=".csv" @change="importModels($event)">
        </div>
    </div>

    <!-- Model Editor View -->
    <div class="model-editor-view" x-show="currentView === 'models'">
        <div class="three-column-layout">
            <div class="left-pane">
                <h2>Point Breakdown</h2>
                <div x-data="{ 
                    capabilities: selectedModel ? getCapabilities(selectedModel) : null,
                    breakdown: selectedModel ? getPointBreakdown(selectedModel) : null,
                    chart: null,
                    pieChart: null
                }"
                x-effect="capabilities = selectedModel ? getCapabilities(selectedModel) : null; 
                          breakdown = selectedModel ? getPointBreakdown(selectedModel) : null;">
                    
                    <!-- Point Breakdown Section -->
                    <div class="point-breakdown" x-show="selectedModel !== null">
                        <div class="breakdown-header">Absolute Point Calculation:</div>
                        <div class="breakdown-base">Base Cost: 10</div>
                        <template x-if="breakdown">
                            <template x-for="(baseValue, stat) in breakdown.baseValues" :key="stat">
                                <div class="breakdown-item">
                                    <span x-text="formatStatName(stat) + ':'"></span>
                                    <span x-text="baseValue.toFixed(1)"></span>
                                    <template x-if="Math.abs(breakdown.adjustedValues[stat] - baseValue) > 0.1">
                                        <span class="adjusted-value" 
                                            x-text="' â†’ ' + breakdown.adjustedValues[stat].toFixed(1)"></span>
                                    </template>
                                    <!-- Add percentage contribution calculation -->
                                    <span class="percentage-value" 
                                          x-text="' (' + Math.round((breakdown.adjustedValues[stat] / (breakdown.total - 10)) * 100) + '%)'"></span>
                                </div>
                            </template>
                            <div class="breakdown-total">
                                Absolute Total: <span x-text="breakdown.total.toFixed(1)"></span>
                            </div>
                        </template>
                        <template x-if="!breakdown">
                            <div>Select a model to see breakdown</div>
                        </template>
                    </div>

                    <!-- Capability Bar Chart -->
                    <div class="capability-chart" x-show="selectedModel !== null"
                        x-init="$watch('capabilities', (value) => { 
                            if (value) {
                                if (chart) chart.destroy();
                                const ctx = $refs.capabilityCanvas.getContext('2d');
                                
                                // Calculate the maximum value for the y-axis
                                const dataValues = [
                                    value.shooting,
                                    value.combat,
                                    value.defense,
                                    value.movement,
                                    value.other
                                ];
                                const maxValue = Math.max(...dataValues);
                                const yAxisMax = Math.max(20, Math.ceil(maxValue * 1.1)); // At least 20, with 10% headroom
                                
                                chart = new Chart(ctx, {
                                    type: 'bar',
                                    data: {
                                        labels: ['Shooting', 'Combat', 'Defense', 'Movement', 'Other'],
                                        datasets: [{
                                            label: 'Capability Points',
                                            data: dataValues,
                                            backgroundColor: [
                                                'rgba(255, 120, 0, 0.8)',   // Fiery orange (Shooting)
                                                'rgba(180, 20, 20, 0.8)',    // Blood red (Combat)
                                                'rgba(70, 130, 180, 0.8)',   // Steel blue (Defense)
                                                'rgba(50, 200, 100, 0.8)',    // Swift green (Movement)
                                                'rgba(199, 21, 133, 0.8)'    // Bright pinkish purple (Other)
                                            ],
                                            borderColor: [
                                                'rgba(255, 120, 0, 1)',     // Fiery orange (Shooting)
                                                'rgba(180, 20, 20, 1)',      // Blood red (Combat)
                                                'rgba(70, 130, 180, 1)',     // Steel blue (Defense)
                                                'rgba(50, 200, 100, 1)',      // Swift green (Movement)
                                                'rgba(199, 21, 133, 1)'      // Bright pinkish purple (Other)
                                            ],
                                            borderWidth: 0
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        animation: {
                                            duration: 0 // Set animation duration to 0 to make it instant
                                        },
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                max: yAxisMax,
                                                grid: {
                                                    color: 'rgba(0, 0, 0, 0.1)'
                                                },
                                                ticks: {
                                                    stepSize: 5
                                                }
                                            }
                                        },
                                        plugins: {
                                            legend: {
                                                display: false
                                            },
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        return context.parsed.y.toFixed(1) + ' points';
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                            }
                        });">
                        <div class="capability-chart-header">Capability Costs:</div>
                        <template x-if="capabilities">
                            <div class="chart-container">
                                <canvas x-ref="capabilityCanvas"></canvas>
                            </div>
                        </template>
                        <template x-if="!capabilities">
                            <div>Select a model to see capabilities</div>
                        </template>
                    </div>

                    <!-- Capability Pie Chart -->
                    <div class="capability-pie-chart" x-show="selectedModel !== null"
                        x-init="$watch('capabilities', (value) => { 
                            if (value) {
                                if (pieChart) pieChart.destroy();
                                const pieCtx = $refs.pieCanvas.getContext('2d');
                                
                                pieChart = new Chart(pieCtx, {
                                    type: 'pie',
                                    data: {
                                        labels: ['Shooting', 'Combat', 'Defense', 'Movement', 'Other'],
                                        datasets: [{
                                            data: [
                                                value.shooting,
                                                value.combat,
                                                value.defense,
                                                value.movement,
                                                value.other
                                            ],
                                            backgroundColor: [
                                                'rgba(255, 120, 0, 0.8)',   // Fiery orange (Shooting)
                                                'rgba(180, 20, 20, 0.8)',    // Blood red (Combat)
                                                'rgba(70, 130, 180, 0.8)',   // Steel blue (Defense)
                                                'rgba(50, 200, 100, 0.8)',    // Swift green (Movement)
                                                'rgba(199, 21, 133, 0.8)'    // Bright pinkish purple (Other)
                                            ],
                                            borderColor: [
                                                'rgba(255, 120, 0, 1)',     // Fiery orange (Shooting)
                                                'rgba(180, 20, 20, 1)',      // Blood red (Combat)
                                                'rgba(70, 130, 180, 1)',     // Steel blue (Defense)
                                                'rgba(50, 200, 100, 1)',      // Swift green (Movement)
                                                'rgba(199, 21, 133, 1)'      // Bright pinkish purple (Other)
                                            ],
                                            borderWidth: 0
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        animation: {
                                            duration: 0 // Make animation instant
                                        },
                                        plugins: {
                                            legend: {
                                                position: 'right',
                                                labels: {
                                                    font: {
                                                        size: 11
                                                    }
                                                }
                                            },
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        const value = context.parsed;
                                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                        const percentage = Math.round((value * 100) / total);
                                                        return `${value.toFixed(1)} points (${percentage}%)`;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                            }
                        });">
                        <div class="capability-chart-header">Cost Distribution:</div>
                        <template x-if="capabilities">
                            <div class="pie-chart-container">
                                <canvas x-ref="pieCanvas"></canvas>
                            </div>
                        </template>
                        <template x-if="!capabilities">
                            <div>Select a model to see capability distribution</div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="center-pane">
                <div :class="{'point-config-hidden': !showPointConfig}">
                    <div class="models-table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="tooltip" data-tooltip="Points cost">Pts</th>
                                    <th>Name</th>
                                    <th class="tooltip" data-tooltip="Movement: How far the model can move in inches">M</th>
                                    <th class="tooltip" data-tooltip="Weapon Skill: Ability in close combat">WS</th>
                                    <th class="tooltip" data-tooltip="Ballistic Skill: Accuracy with ranged weapons (lower is better)">BS</th>
                                    <th class="tooltip" data-tooltip="Strength: Physical power of the model in combat">S</th>
                                    <th class="tooltip" data-tooltip="Toughness: Difficulty to wound the model">T</th>
                                    <th class="tooltip" data-tooltip="Wounds: Amount of damage the model can sustain">W</th>
                                    <th class="tooltip" data-tooltip="Initiative: Speed and combat reaction time">I</th>
                                    <th class="tooltip" data-tooltip="Attacks: Number of close combat attacks">A</th>
                                    <th class="tooltip" data-tooltip="Leadership: Bravery and morale of the model">Ld</th>
                                    <th class="tooltip" data-tooltip="Save: Armor save value (lower is better)">Sv</th>
                                    <th class="tooltip" data-tooltip="Invulnerable Save: Special save that cannot be modified (lower is better)">Inv</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(model, index) in models" :key="index">
                                    <tr >
                                        <td @click="selectedModel = model" :class="{'selected-model': selectedModel === model}">
                                            <span style="display: inline-block; cursor: pointer;" x-text="getRelativePoints(model, index)"></span>
                                            <span x-text="selectedModel === model ? 'â—€' : 'â–¼'" class="breakdown-arrow"></span>
                                        </td>
                                        <td><input type="text" x-model="model.name" placeholder="Model name"></td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="number" x-model.number="model.movement" min="1" max="12">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementNumeric(model, 'movement')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementNumeric(model, 'movement')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="number" x-model.number="model.weaponSkill" min="1" max="10">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementNumeric(model, 'weaponSkill')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementNumeric(model, 'weaponSkill')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="text" x-model="model.ballisticSkill" @blur="ensurePlusSign(model, 'ballisticSkill')">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementSkill(model, 'ballisticSkill')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementSkill(model, 'ballisticSkill')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="number" x-model.number="model.strength" min="1" max="10">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementNumeric(model, 'strength')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementNumeric(model, 'strength')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="number" x-model.number="model.toughness" min="1" max="10">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementNumeric(model, 'toughness')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementNumeric(model, 'toughness')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="number" x-model.number="model.wounds" min="1" max="10">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementNumeric(model, 'wounds')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementNumeric(model, 'wounds')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="number" x-model.number="model.initiative" min="1" max="10">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementNumeric(model, 'initiative')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementNumeric(model, 'initiative')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="number" x-model.number="model.attacks" min="1" max="10">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementNumeric(model, 'attacks')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementNumeric(model, 'attacks')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="number" x-model.number="model.leadership" min="1" max="10">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementNumeric(model, 'leadership')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementNumeric(model, 'leadership')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="text" x-model="model.save" @blur="ensurePlusSign(model, 'save')">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementSkill(model, 'save')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementSkill(model, 'save')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="skill-input-wrapper">
                                                <input type="text" x-model="model.invulnSave" @blur="ensurePlusSign(model, 'invulnSave')">
                                                <div class="spinner-buttons">
                                                    <button class="spinner-button" @click="incrementSkill(model, 'invulnSave')" title="Increase">â–²</button>
                                                    <button class="spinner-button" @click="decrementSkill(model, 'invulnSave')" title="Decrease">â–¼</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="delete-btn tooltip" @click="removeModel(index)" :disabled="models.length === 1" data-tooltip="Delete this model">X</button>
                                            <button class="tooltip" @click="duplicateModel(index)" data-tooltip="Create a copy of this model">C</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <div class="import-export-container">
                        </div>
                        
                        <div class="total-points hidden">
                            Total Points: <span x-text="getTotalPoints()"></span>
                        </div>
                        
                        <button @click="showPointConfig = !showPointConfig" class="config-btn">
                            <span x-text="showPointConfig ? 'Hide Point Matrix' : 'Show Point Matrix'"></span>
                            <span class="arrow-icon" :class="{'arrow-up': !showPointConfig}">â–¼</span>
                        </button>
                    </div>
                    
                    <div class="scrollable-content">
                        <div x-show="showPointConfig" class="point-config-tables">
                            <div class="point-config-header">
                                <h3>Point Value Configuration</h3>
                                <div class="point-config-actions">
                                    <button @click="exportPointValues" class="export-btn">Export Configuration</button>
                                    <label class="import-btn" for="importPointValues">Import Configuration</label>
                                    <input type="file" id="importPointValues" @change="importPointValues($event)" accept=".json">
                                </div>
                            </div>

                            <div class="stat-nav">
                                <div class="stat-nav-label">Current Stat:</div>
                                <div class="stat-buttons">
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'movement'"
                                        x-bind:class="{'active': currentStat === 'movement'}">M</button>
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'weaponSkill'"
                                        x-bind:class="{'active': currentStat === 'weaponSkill'}">WS</button>
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'ballisticSkill'"
                                        x-bind:class="{'active': currentStat === 'ballisticSkill'}">BS</button>
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'strength'"
                                        x-bind:class="{'active': currentStat === 'strength'}">S</button>
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'toughness'"
                                        x-bind:class="{'active': currentStat === 'toughness'}">T</button>
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'wounds'"
                                        x-bind:class="{'active': currentStat === 'wounds'}">W</button>
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'attacks'"
                                        x-bind:class="{'active': currentStat === 'attacks'}">A</button>
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'leadership'"
                                        x-bind:class="{'active': currentStat === 'leadership'}">Ld</button>
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'save'"
                                        x-bind:class="{'active': currentStat === 'save'}">Sv</button>
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'invulnSave'"
                                        x-bind:class="{'active': currentStat === 'invulnSave'}">Inv</button>
                                    <button 
                                        class="stat-button" 
                                        x-on:click="currentStat = 'weights'"
                                        x-bind:class="{'active': currentStat === 'weights'}">Weights</button>
                                </div>
                            </div>

                            <div class="single-stat-config" x-show="currentStat !== 'weights'">
                                <h4>
                                    <span x-text="formatStatName(currentStat)"></span>
                                    <span> Multiplier: </span>
                                    <input type="number"
                                           x-model.number="statMultipliers[currentStat]"
                                           min="0"
                                           step="0.1"
                                           class="weight-input"
                                           @input="$nextTick(() => $forceUpdate())"
                                           :style="{ backgroundColor: getMultiplierColor(statMultipliers[currentStat]) }">
                                </h4>
                                <table class="config-table">
                                    <tr>
                                        <th>Value</th>
                                        <th>Points</th>
                                        <th>Scaled</th>
                                    </tr>
                                    <template x-for="(points, value) in pointValueLookups[currentStat]" :key="value">
                                        <tr>
                                            <td x-text="value"></td>
                                            <td>
                                                <input type="number" 
                                                       x-model.number="pointValueLookups[currentStat][value]"
                                                       class="point-input">
                                            </td>
                                            <td>
                                                <span x-text="(pointValueLookups[currentStat][value] * statMultipliers[currentStat]).toFixed(1)" style="font-size: 0.9em;"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </table>
                            </div>

                            <!-- Weight Matrix Editor -->
                            <div class="weight-matrix-container" x-show="currentStat === 'weights'">
                                <h4>Stat Weight Matrix</h4>
                                <p class="matrix-info">This matrix defines how stats affect each other. Each row represents a source stat, and each column represents a target stat. The value at the intersection represents the influence of the source on the target.</p>
                                
                                <div class="weight-matrix-actions">
                                    <button @click="saveWeightMatrix" class="save-weights-btn">Save Weight Matrix</button>
                                    <button @click="resetWeightMatrix" class="reset-weights-btn">Reset to Default</button>
                                    <button @click="includeWeightMatrixInExport = !includeWeightMatrixInExport" 
                                            class="toggle-weights-btn"
                                            x-bind:class="{'active': includeWeightMatrixInExport}">
                                        <span x-text="includeWeightMatrixInExport ? 'Included in Export' : 'Click to include in Export'"></span>
                                    </button>
                                </div>
                                
                                <div class="weight-matrix-scroll">
                                    <table class="weight-matrix-table">
                                        <thead>
                                            <tr>
                                                <th>Targetâ†’ Sourceâ†“</th>
                                                <template x-for="(statName, index) in Object.keys(statMultipliers)" :key="statName">
                                                    <th class="tooltip" :data-tooltip="'Base cost multiplier for ' + formatStatName(statName)">
                                                        <div x-text="getStatShortName(statName)"></div>
                                                        <input type="number"
                                                               x-model.number="statMultipliers[statName]"
                                                               min="0"
                                                               step="0.1"
                                                               class="weight-input"
                                                               style="margin-top: 2px;"
                                                               @input="$nextTick(() => $forceUpdate())"
                                                               :style="{ backgroundColor: getMultiplierColor(statMultipliers[statName]) }">
                                                    </th>
                                                </template>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="(weights, sourceStat) in statWeightMatrix" :key="sourceStat">
                                                <tr>
                                                    <td x-text="getStatShortName(sourceStat)" class="weight-source-stat tooltip" :data-tooltip="'This row controls how much ' + formatStatName(sourceStat) + ' adds to the cost of each stat'"></td>
                                                    <template x-for="(weight, i) in weights" :key="i">
                                                        <td>
                                                            <span class="tooltip" 
                                                                  :data-tooltip="'model\'s ' + formatStatName(sourceStat) + ' ' + (statWeightMatrix[sourceStat][i] > 0 ? 'increases' : statWeightMatrix[sourceStat][i] < 0 ? 'decreases' : 'has no effect on') + ' cost of ' + formatStatName(getStatAtIndex(i))">
                                                                <input type="number" 
                                                                       x-model.number="statWeightMatrix[sourceStat][i]" 
                                                                       min="-2" 
                                                                       max="2" 
                                                                       step="0.1"
                                                                       class="weight-input"
                                                                       :class="{'active-weight': statWeightMatrix[sourceStat][i] > 0, 'negative-weight': statWeightMatrix[sourceStat][i] < 0}">
                                                            </span>
                                                        </td>
                                                    </template>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="weight-description">
                                    <h5>Current Dependencies:</h5>
                                    <ul class="dependency-list">
                                        <template x-for="(weights, sourceStat) in statWeightMatrix" :key="sourceStat">
                                            <template x-for="(weight, i) in weights" :key="i">
                                                <li x-show="weight != 0">
                                                    <span x-text="formatStatName(sourceStat)"></span> 
                                                    <span x-text="weight > 0 ? 'increases' : 'decreases'"></span> value of 
                                                    <span x-text="formatStatName(getStatAtIndex(i))"></span> 
                                                    with weight <span x-text="Math.abs(weight)"></span>
                                                </li>
                                            </template>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-pane">
                <h2>Scenario Results</h2>
                <div x-show="!selectedModel">
                    <p>Select a model to see relevant scenario results.</p>
                </div>
                <div x-show="selectedModel">
                    <!-- ++ START: Assigned Equipment Section (Modified) ++ -->
                    <div class="assigned-equipment-section" style="margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
                        <h4>Assigned Equipment:</h4>
                        <template x-if="selectedModel.assignedArmoryItemIds && selectedModel.assignedArmoryItemIds.length > 0">
                            <ul style="list-style: none; padding-left: 0;">
                                <template x-for="itemId in selectedModel.assignedArmoryItemIds" :key="itemId">
                                    <li style="margin-bottom: 3px; display: flex; justify-content: space-between; align-items: center;">
                                        <span x-text="getArmoryItemById(itemId)?.name || 'Unknown Item (' + itemId + ')'" style="font-size: 0.9em;"></span>
                                        <button @click="removeEquipmentFromModel(itemId)" class="remove-equip-btn" title="Remove Item">X</button>
                                    </li>
                                </template>
                            </ul>
                        </template>
                        <template x-if="!selectedModel.assignedArmoryItemIds || selectedModel.assignedArmoryItemIds.length === 0">
                            <p style="font-style: italic; font-size: 0.9em;">No equipment assigned.</p>
                        </template>
                        
                        <!-- Add Equipment Input/List -->
                        <div class="add-equipment-controls" style="margin-top: 10px; border-top: 1px solid #ccc; padding-top: 10px;">
                            <input type="text" 
                                   x-model="equipmentSearchTerm"
                                   placeholder="Add equipment..."
                                   class="equipment-search-input"
                                   style="width: calc(100% - 10px); margin-bottom: 5px;">
                            
                            <div class="available-items-list" x-show="equipmentSearchTerm.length > 0 && availableArmoryItemsForSelectedModel.length > 0"
                                 style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; background-color: #fff;">
                                <template x-for="item in availableArmoryItemsForSelectedModel" :key="item.id">
                                    <div @click="addEquipmentToModel(item.id)"
                                         class="available-item"
                                         style="padding: 4px 8px; cursor: pointer; border-bottom: 1px solid #eee;">
                                        <span x-text="item.name"></span> 
                                        (<span x-text="item.type" style="font-style: italic; font-size: 0.9em;"></span>)
                                        <!-- (<span x-text="item.baseCost"></span> pts) -->
                                    </div>
                                </template>
                            </div>
                            <div x-show="equipmentSearchTerm.length > 0 && availableArmoryItemsForSelectedModel.length === 0" 
                                 style="font-style: italic; font-size: 0.9em; color: #777;">
                                No matching items found or all assigned.
                            </div>
                        </div>
                    </div>
                    <!-- ++ END: Assigned Equipment Section ++ -->

                    <!-- Loop through scenarios and display relevant results -->
                    <template x-for="scenario in scenarios" :key="scenario.id">
                        <!-- Check if the scenario involves the selectedModel as the attacker -->
                        <div class="scenario-result-item">
                            <h4>
                                <span x-text="scenario.name || 'Unnamed Scenario'"></span>
                                (<span x-text="scenario.type" style="font-style: italic; font-size: 0.9em;"></span>)
                            </h4>
                            <pre x-text="getScenarioResults(scenario, selectedModel)" style="white-space: pre-wrap; font-size: 0.9em; background-color: #f8f8f8; padding: 5px; border-radius: 3px;"></pre>
                        </div>
                        <!-- Add checks for other scenario types later (e.g., selectedModel as defender) -->
                         <!-- 
                        <div x-show="scenario.type === 'meleeDefense' && getModelById(scenario.attackingModelId)"> 
                            ... display defense results ...
                        </div>
                        -->
                    </template>
                    <div x-show="selectedModel && scenarios.filter(s => s.type === 'meleeAttack').length === 0">
                        <p>No relevant attack scenarios defined for <span x-text="selectedModel.name || 'this model'"></span>.</p>
                        <p><small>Go to the Scenario Editor tab to create some!</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scenario Editor View -->
    <div class="scenario-editor-view" x-show="currentView === 'scenarios'">
        <h2>Scenario Editor</h2>
        <div class="scenario-editor-layout">
            <div class="scenario-list-pane">
                <h3>Defined Scenarios</h3>
                <!-- Scenario list -->
                <ul>
                    <li x-show="scenarios.length === 0">No scenarios defined yet.</li>
                    <!-- Use x-for to display scenarios -->
                    <template x-for="scenario in scenarios" :key="scenario.id">
                        <li @click="selectedScenarioId = scenario.id"
                            :class="{'selected-scenario': selectedScenarioId === scenario.id}">
                            <span x-text="scenario.name || 'Unnamed Scenario'"></span> 
                            (<span x-text="scenario.type || 'unknown type'" style="font-style: italic; font-size: 0.9em;"></span>)
                        </li>
                    </template>
                </ul>
                <!-- Scenario Action Buttons -->
                <div class="scenario-actions">
                    <button @click="addScenario()">Add New Scenario</button>
                    <button @click="deleteScenario()" :disabled="!selectedScenarioId" class="delete-btn">Delete Selected</button>
                    <button @click="exportScenarios()" class="export-btn">Export Scenarios</button>
                    <label class="import-btn" for="importScenariosInput">Import Scenarios</label>
                    <input type="file" id="importScenariosInput" accept=".json" @change="importScenarios($event)" style="display: none;">
                 </div>
            </div>
            <div class="scenario-form-pane">
                <h3>Edit Scenario</h3>
                <div x-show="!selectedScenario">
                    <p>Select a scenario from the list to edit, or add a new one.</p>
                </div>
                <template x-if="selectedScenario">
                    <div x-init="$watch('selectedScenario', (value) => { 
                            console.log('Scenario changed, saving...'); 
                            saveScenarios(); 
                         }, { deep: true })">
                        <!-- Scenario Name -->
                        <div class="form-group">
                            <label for="scenarioName">Scenario Name:</label>
                            <input type="text" id="scenarioName" x-model="selectedScenario.name" placeholder="Enter scenario name">
                        </div>

                        <!-- Scenario Type -->
                        <div class="form-group">
                            <label for="scenarioType">Scenario Type:</label>
                            <select id="scenarioType" x-model="selectedScenario.type">
                                <option value="meleeAttack">Melee Attack</option>
                                <!-- Add other types later: -->
                                <option value="rangedAttack">Ranged Attack</option>
                                <!--
                                <option value="meleeDefense">Melee Defense</option>
                                -->
                                <option value="rangedDefense">Ranged Defense</option>
                            </select>
                        </div>

                        <!-- Melee Attack Specific Fields -->
                        <div x-show="selectedScenario.type === 'meleeAttack' || selectedScenario.type === 'rangedAttack'" class="scenario-type-fields">
                            <h4>Target Selection</h4>
                            <div class="form-group">
                                <label for="targetModels">Target Models:</label>
                                <select id="targetModels" x-model="selectedScenario.targetModelIds" multiple size="5" style="width: 100%;">
                                    <!-- Populate options dynamically -->
                                    <template x-for="model in models" :key="model.id">
                                        <!-- Only show models that *could* be targets (optional: exclude self?) -->
                                        <option :value="model.id" x-text="model.name || 'Unnamed Model'"></option>
                                    </template>
                                </select>
                                <small>Hold Ctrl/Cmd to select multiple targets.</small>
                            </div>
                        </div>

                        <!-- Placeholder for Ranged Attack Fields -->
                        <!-- REMOVED: Replaced by showing the Melee section for Ranged attacks too -->
                        <!-- <div x-show="selectedScenario.type === 'rangedAttack'" class="scenario-type-fields"> -->
                        <!--    <h4>Ranged Attack Options</h4> -->
                        <!--    <p>(Weapon profile and target selection will go here)</p> -->
                        <!-- </div> -->

                        <!-- Placeholder for Defense Fields -->
                        <div x-show="selectedScenario.type === 'meleeDefense' || selectedScenario.type === 'rangedDefense'" class="scenario-type-fields">
                            <h4>Defense Options</h4>
                            <p>(Attacking model/weapon selection will go here)</p>
                        </div>
                        <!-- Ranged Defense Specific Fields -->
                        <div x-show="selectedScenario.type === 'rangedDefense'" class="scenario-type-fields">
                            <h4>Ranged Defense Options</h4>
                            <div class="form-group">
                                <label for="attackingModels">Attacking Models:</label>
                                <!-- Ensure scenario object has attackingModelIds -->
                                <select id="attackingModels" x-model="selectedScenario.attackingModelIds" multiple size="5" style="width: 100%;">
                                    <template x-for="model in models" :key="model.id">
                                        <!-- Option to exclude the defender later? -->
                                        <option :value="model.id" x-text="model.name || 'Unnamed Model'"></option>
                                    </template>
                                </select>
                                <small>Hold Ctrl/Cmd to select multiple attackers. Attackers will use their first equipped ranged weapon.</small>
                            </div>
                            <!-- Add weapon selection later if needed -->
                        </div>

                        <!-- Add a Save button later if needed, or rely on x-model auto-updating -->
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Armory Items View -->
    <div class="armory-view" x-show="currentView === 'armory'" style="padding-top: 70px;">
        <h2>Armory Items</h2>
        <div class="armory-layout">
            <div class="armory-list-pane">
                <h3>Item List</h3>
                <!-- ++ Search Input ++ -->
                <div class="armory-search-bar">
                    <input type="text" x-model="armorySearchTerm" placeholder="Search items..." class="search-input">
                </div>
                <ul>
                    <li x-show="armoryItems.filter(item => item.name.toLowerCase().includes(armorySearchTerm.toLowerCase())).length === 0">
                        No matching items found.
                    </li>
                    <!-- Updated x-for to filter based on armorySearchTerm -->
                    <template x-for="item in armoryItems.filter(item => item.name.toLowerCase().includes(armorySearchTerm.toLowerCase()))" :key="item.id">
                        <li @click="selectedArmoryItemId = item.id"
                            :class="{'selected-armory-item': selectedArmoryItemId === item.id}">
                            <span x-text="item.name || 'Unnamed Item'"></span> 
                            (<span x-text="item.type || 'unknown'" style="font-style: italic; font-size: 0.9em;"></span>)
                        </li>
                    </template>
                </ul>
                <div class="armory-actions">
                    <button @click="addArmoryItem()">Add New Item</button>
                    <!-- Add export/import later if needed -->
                </div>
            </div>
            <div class="armory-form-pane">
                <h3>Edit Item Details</h3>
                <div x-show="!selectedArmoryItemId">
                    <p>Select an item from the list to edit, or add a new one.</p>
                </div>
                <div x-show="selectedArmoryItemId" x-data="{ currentItem: null }" 
                     x-init="$watch('selectedArmoryItemId', id => { 
                                console.log('Watcher triggered. Selected ID:', id, 'Type:', typeof id);
                                let foundItem = armoryItems.find(item => item.id === id);
                                console.log('Found item (before defaults):', foundItem);
                                
                                // Pre-fill defaults for ranged weapons if stats are null/undefined
                                if (foundItem && foundItem.type === 'rangedWeapon') {
                                    if (foundItem.range === null || foundItem.range === undefined) {
                                        foundItem.range = 24;
                                    }
                                    if (foundItem.strength === null || foundItem.strength === undefined) {
                                        foundItem.strength = 4;
                                    }
                                    if (foundItem.ap === null || foundItem.ap === undefined) {
                                        foundItem.ap = 0;
                                    }
                                    if (foundItem.attacks === null || foundItem.attacks === undefined) {
                                        foundItem.attacks = 1;
                                    }
                                    console.log('Item after ranged defaults:', foundItem);
                                }
                                
                                currentItem = foundItem || null;
                                console.log('currentItem set to:', currentItem);
                             })">
                    <template x-if="currentItem">
                        <div> <!-- Wrapper div -->
                            <div class="form-group">
                                <label :for="'itemName-' + currentItem.id">Item Name:</label>
                                <input type="text" :id="'itemName-' + currentItem.id" x-model="currentItem.name" placeholder="Enter item name" @change="saveArmoryItems()">
                            </div>
                            <div class="form-group">
                                <label :for="'itemType-' + currentItem.id">Item Type:</label>
                                <select :id="'itemType-' + currentItem.id" x-model="currentItem.type" @change="saveArmoryItems()">
                                    <option value="wargear">Wargear</option>
                                    <option value="specialRule">Special Rule</option>
                                    <option value="rangedWeapon">Ranged Weapon</option>
                                    <option value="meleeWeapon">Melee Weapon</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label :for="'itemDesc-' + currentItem.id">Description:</label>
                                <textarea :id="'itemDesc-' + currentItem.id" x-model="currentItem.description" placeholder="Enter description" rows="1" @change="saveArmoryItems()"></textarea>
                            </div>
                            <div class="form-group">
                                <label :for="'itemBaseCost-' + currentItem.id">Base Cost:</label>
                                <input type="number" :id="'itemBaseCost-' + currentItem.id" x-model.number="currentItem.baseCost" placeholder="0" @change="saveArmoryItems()">
                            </div>

                            <!-- ++ Ranged Weapon Stats (Conditional) ++ -->
                            <div x-show="currentItem.type === 'rangedWeapon'" class="weapon-stats-group">
                                <h4>Ranged Weapon Stats</h4>
                                <table class="armory-ranged-stats-table">
                                    <thead>
                                        <tr>
                                            <th>Range</th>
                                            <th>S</th>
                                            <th>AP</th>
                                            <th>A</th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <input type="number" x-model.number="currentItem.range" placeholder="e.g., 24" @change="saveArmoryItems()">
                                            </td>
                                            <td>
                                                <div class="skill-input-wrapper">
                                                    <input type="number" x-model.number="currentItem.strength" placeholder="e.g., 4" @change="saveArmoryItems()">
                                                    <div class="spinner-buttons">
                                                        <button class="spinner-button" @click="incrementArmoryStat(currentItem, 'strength')" title="Increase">â–²</button>
                                                        <button class="spinner-button" @click="decrementArmoryStat(currentItem, 'strength')" title="Decrease">â–¼</button>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="skill-input-wrapper">
                                                    <input type="text" 
                                                        :value="(currentItem.ap == 0 && currentItem.ap !== null && currentItem.ap !== undefined) ? '-' : currentItem.ap" 
                                                        @input="currentItem.ap = ($event.target.value === '-' ? 0 : $event.target.value); saveArmoryItems()" 
                                                        placeholder="e.g., 0 or -" >
                                                    <div class="spinner-buttons">
                                                        <button class="spinner-button" @click="incrementArmoryAP(currentItem)" title="Increase AP (Worse)">â–²</button>
                                                        <button class="spinner-button" @click="decrementArmoryAP(currentItem)" title="Decrease AP (Better)">â–¼</button>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <input type="number" x-model.number="currentItem.attacks" placeholder="e.g., 1" @change="saveArmoryItems()">
                                            </td>
                                            <td>
                                                <select x-model="currentItem.weaponType" @change="saveArmoryItems()">
                                                    <option value="Heavy">Heavy</option>
                                                    <option value="Rapid Fire">Rapid Fire</option>
                                                    <option value="Assault">Assault</option>
                                                    <option value="Pistol">Pistol</option>
                                                </select>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- ++ Melee Weapon Stats (Conditional) ++ -->
                            <div x-show="currentItem.type === 'meleeWeapon'" class="weapon-stats-group">
                                <h4>Melee Weapon Stats</h4>
                                <div class="melee-stats-horizontal">
                                    <div class="form-group">
                                        <label :for="'itemMeleeStrength-' + currentItem.id">Str:</label>
                                        <select :id="'itemMeleeStrength-' + currentItem.id" x-model="currentItem.meleeStrength" @change="saveArmoryItems()">
                                            <option value="-1">-1</option>
                                            <option value="-">user</option> <!-- Default -->
                                            <option value="+1">+1</option>
                                            <option value="+2">+2</option>
                                            <option value="+3">+3</option>
                                            <option value="x2">x2</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label :for="'itemAp-' + currentItem.id">AP:</label>
                                        <div class="skill-input-wrapper">
                                            <input type="text" 
                                                :id="'itemAp-' + currentItem.id" 
                                                :value="(currentItem.ap == 0 && currentItem.ap !== null && currentItem.ap !== undefined) ? '-' : currentItem.ap" 
                                                @input="currentItem.ap = ($event.target.value === '-' ? 0 : $event.target.value); saveArmoryItems()" 
                                                placeholder="-" >
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementArmoryAP(currentItem)" title="Increase AP (Worse)">â–²</button>
                                                <button class="spinner-button" @click="decrementArmoryAP(currentItem)" title="Decrease AP (Better)">â–¼</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label :for="'itemMeleeAttacks-' + currentItem.id">Melee Attacks:</label>
                                        <select :id="'itemMeleeAttacks-' + currentItem.id" x-model="currentItem.meleeAttacks" @change="saveArmoryItems()">
                                            <option value="-1">-1</option>
                                            <option value="-">user</option>
                                            <option value="+1">+1</option>
                                            <option value="+2">+2</option>
                                            <option value="+3">+3</option>
                                            <option value="x2">x2</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- ++ Stat Weights Modifier Table ++ -->
                            <div class="item-weights-group"> <!-- New wrapper group -->
                                <h4>Stat Cost Modifiers (Item Cost)</h4>
                                <p class="item-weights-info">Define how the wielder's stats affect the item's point cost.</p>
                                <div class="armory-item-weights-scroll"> <!-- Scroll wrapper if needed -->
                                    <table class="armory-item-weights-table">
                                        <thead>
                                            <tr>
                                                <!-- Generate headers using statMultipliers keys and getStatShortName -->
                                                <template x-for="(statName, index) in Object.keys(statMultipliers)" :key="statName">
                                                     <th x-text="getStatShortName(statName)" class="tooltip" :data-tooltip="formatStatName(statName)"></th>
                                                </template>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                 <!-- Generate input cells bound to currentItem.statWeights[index] -->
                                                <template x-for="(statName, index) in Object.keys(statMultipliers)" :key="statName">
                                                    <td>
                                                        <div class="skill-input-wrapper">
                                                            <input type="number"
                                                                   x-model.number="currentItem.statWeights[index]"
                                                                   step="0.1"
                                                                   class="item-weight-input"
                                                                   @change="saveArmoryItems()"
                                                                   :style="{ backgroundColor: getMultiplierColor(mapWeightToColorValue(currentItem.statWeights[index])) }"
                                                                   :class="{'active-weight': currentItem.statWeights[index] > 0, 'negative-weight': currentItem.statWeights[index] < 0}">
                                                            <div class="spinner-buttons">
                                                                <button class="spinner-button" @click="incrementArmoryWeight(currentItem, index)" title="Increase">â–²</button>
                                                                <button class="spinner-button" @click="decrementArmoryWeight(currentItem, index)" title="Decrease">â–¼</button>
                                                            </div>
                                                        </div>
                                                   </td>
                                                </template>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="armory-item-actions">
                                <button @click="duplicateArmoryItem(currentItem.id)" class="duplicate-btn">Duplicate</button>
                                <button @click="removeArmoryItem(currentItem.id)" class="delete-btn">Delete Item</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip positioning script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.body.addEventListener('mouseover', function(e) {
                // Check if we're hovering over a tooltip element
                if (e.target.classList.contains('tooltip') || e.target.closest('.tooltip')) {
                    const tooltipEl = e.target.classList.contains('tooltip') ? e.target : e.target.closest('.tooltip');
                    
                    // Create a function to position the tooltip when it appears
                    tooltipEl.addEventListener('mouseenter', function() {
                        // Small delay to allow the pseudo-element to be created
                        setTimeout(() => {
                            // Get tooltip dimensions (have to use a hack for pseudo-elements)
                            // Add a temporary data attribute to identify this specific tooltip
                            const uniqueId = 'tooltip-' + Math.random().toString(36).substring(2);
                            tooltipEl.setAttribute('data-tooltip-id', uniqueId);
                            
                            // Get position of the tooltip element (not the cursor)
                            const rect = tooltipEl.getBoundingClientRect();
                            // Use the element's top and horizontal center for positioning
                            const tooltipTop = Math.max(rect.top - 40, 60); // Position above the element with minimum 60px from top
                            const tooltipLeft = rect.left + (rect.width / 2) - 70; // Center horizontally
                            
                            // Create a style element to get the pseudo-element
                            const style = document.createElement('style');
                            style.innerHTML = `
                                .tooltip[data-tooltip-id="${uniqueId}"]::after {
                                    top: ${tooltipTop}px !important; 
                                    left: ${tooltipLeft}px !important;
                                }
                            `;
                            document.head.appendChild(style);
                            
                            // Clean up after tooltip is no longer hovered
                            tooltipEl.addEventListener('mouseleave', function() {
                                document.head.removeChild(style);
                                tooltipEl.removeAttribute('data-tooltip-id');
                            }, { once: true });
                        }, 10);
                    });
                }
            }, true);
        });
    </script>

    <!-- Joke Captcha Popup -->
    <div x-data="{ 
            showCaptcha: false,
            showConfirmation: false,
            selectedTiles: [],
            initCaptcha() {
                if (!localStorage.getItem('hasSeenCaptcha')) {
                    setTimeout(() => {
                        this.showCaptcha = true;
                    }, 3000);
                }
            },
            handleSubmit() {
                this.showConfirmation = true;
                localStorage.setItem('hasSeenCaptcha', 'true');
                setTimeout(() => {
                    this.showConfirmation = false;
                    this.showCaptcha = false;
                }, 2000);
            },
            toggleTile(index) {
                const tileIndex = this.selectedTiles.indexOf(index);
                if (tileIndex > -1) {
                    this.selectedTiles.splice(tileIndex, 1);
                } else {
                    this.selectedTiles.push(index);
                }
            },
            calculateBgPosition(index) {
                const tileWidth = 100;
                const tileHeight = 101;
                const cols = 4;
                
                const col = (index - 1) % cols;
                const row = Math.floor((index - 1) / cols);
                
                const xPos = -col * tileWidth;
                const yPos = -row * tileHeight;
                
                return `${xPos}px ${yPos}px`;
            }
        }" x-init="initCaptcha()" style="position: relative; z-index: 1000;">

        <div x-show="showCaptcha || showConfirmation" 
             class="captcha-overlay" 
             style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); z-index: 9999;">
             
            <template x-if="showConfirmation">
                <div class="confirmation-modal"
                     style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background-color: #fff; padding: 20px; border-radius: 8px;
                            text-align: center; font-size: 1.2em; font-weight: bold;">
                    Your selections have been noted
                </div>
            </template>

            <template x-if="showCaptcha && !showConfirmation">
                <div class="captcha-modal"
                     style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background-color: #fff; padding: 20px; border-radius: 8px; 
                            text-align: center; width: 400px;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <div class="captcha-header" style="background-color: #007bff; color: white; padding: 12px; font-size: 1.2em; font-weight: bold; margin: -20px -20px 15px -20px; border-radius: 8px 8px 0 0;">
                        Select all squares with Loyalists
                    </div>
                    <div class="captcha-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 15px;">
                        <template x-for="i in 12" :key="i">
                            <div class="captcha-tile"
                                 @click="toggleTile(i)"
                                 :style="{ 
                                     backgroundImage: 'url(img/captcha_background.jpg)', 
                                     backgroundPosition: calculateBgPosition(i),
                                     backgroundSize: '400px 304px',
                                     width: '85px',
                                     height: '85px',
                                     cursor: 'pointer',
                                     border: '2px solid transparent',
                                     position: 'relative',
                                     overflow: 'hidden'
                                 }"
                                 :class="{'selected': selectedTiles.includes(i)}">
                                 <div class="selection-overlay" 
                                      x-show="selectedTiles.includes(i)"
                                      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 123, 255, 0.3); border: 2px solid #007bff;">
                                 </div>
                            </div>
                        </template>
                    </div>
                    <div class="captcha-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-top: 1px solid #eee; margin-top: 15px;">
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer;">
                            <input type="checkbox" style="margin-right: 5px;"> I'm not Alpharius
                        </label>
                        <button @click="handleSubmit()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                            submit
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>
</body>
</html> 