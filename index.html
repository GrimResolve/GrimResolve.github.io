<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grim Resolver</title>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Header styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #c5dac5;
            color: rgb(42, 46, 3);
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.082);
            height: 50px; /* Fixed height */
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }

        /* Adjust body padding to account for fixed header exactly */
        body {
            font-family: Arial, sans-serif;
            margin: 0 auto;
            padding: 20px;
            padding-top: 10px; /* Match header height + some padding */
            background-color: #f0f0f0;
            height: 100vh;
            overflow: hidden; /* Prevent body scrolling */
        }
        
        .hidden {
            display: none;
        }

        .center-pane > div {
            background-color: transparent;
            padding: 0;
            max-width: 940px;
            margin: 0 auto;
        }
        table {
            margin: 0 auto;
            max-width: 940px;
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
        }
        th {
            background-color: #d1d1d1;
        }
        th:first-child, td:first-child {
            width: 60px;
            font-weight: bold;
        }
        .skill-input-wrapper th:nth-child(2), .skill-input-wrapper td:nth-child(2) {
            width: 120px;
        }
        th:not(:first-child):not(:nth-child(2)), td:not(:first-child):not(:nth-child(2)) {
            width: 40px;
        }
        input {
            width: 100%;
            box-sizing: border-box;
        }
        /* Alternating row colors in the model table */
        tbody tr:nth-child(odd) {
            background-color: #dde4dd; /* Light greenish grey */
        }
        /* Hide native spinner buttons only on number inputs within skill-input-wrapper */
        .skill-input-wrapper input[type="number"]::-webkit-inner-spin-button, 
        .skill-input-wrapper input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .skill-input-wrapper input[type="number"] { 
            -moz-appearance: textfield; 
        }
        button {
            margin: 0px 0;
            padding: 4px 8px;
            background-color: #adadad;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .delete-btn {
            background-color: #f44336;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        .total-points {
            margin-top: 20px;
            font-weight: bold;
            text-align: right;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: fixed; /* Change from absolute to fixed */
            z-index: 10000; /* Higher than header's z-index of 1000 */
            background-color: #333333b6;
            color: white;
            text-align: center;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            /* Custom positioning calculation based on hover position */
            /* These will be calculated by JS */
            top: 0;
            left: 0;
            transform: none;
        }

        
        /* File input styling */
        #importInput {
            display: none;
        }
        
        .import-export-container {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            justify-content: flex-start;
        }
        
        .export-btn {
            margin: 10px 0;
        }
        
        .export-btn:hover {
        }
        
        .import-btn {
            background-color: #ff9800;
            /* Add button-specific styles to make the label look like a button */
            margin: 10px 0;
            padding: 4px 8px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
        }
        
        .import-btn:hover {
            background-color: #e68a00;
        }
        
        /* Number input wrapper styles */
        .skill-input-wrapper {
            display: flex;
            align-items: center;
        }
        
        .skill-input-wrapper input {
            flex: 1;
            text-align: center;
        }
        
        .spinner-buttons {
            display: flex;
            flex-direction: column;
            width: 16px;
        }
        
        .spinner-button {
            height: 12px;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            color: #333;
            font-size: 8px;
            line-height: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .spinner-button:hover {
            background-color: #e0e0e0;
        }
        
        /* Point formula table styles */
        .point-formula-container {
            margin-top: 30px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .point-formula-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .point-formula-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .point-formula-table th, .point-formula-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .point-formula-table th {
            background-color: #f2f2f2;
        }
        
        .point-formula-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .point-formula-table tr:hover {
            background-color: #f1f1f1;
        }

        /* Point value configuration styles */
        .config-btn {
            background-color: #3a9989;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .config-btn:hover {
            background-color: #88c0b2;
        }
        
        .arrow-icon {
            display: inline-block;
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .arrow-up {
            transform: rotate(180deg);
        }

        .point-config-tables {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            overflow-y: visible; /* Let parent handle scrolling */
            height: auto; /* Let content determine height */
        }

        .point-config-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .point-config-actions {
            display: flex;
            gap: 10px;
        }

        #importPointValues {
            display: none;
        }

        .point-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-config {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-config h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .config-table {
            width: 100%;
            border-collapse: collapse;
        }

        .config-table th,
        .config-table td {
            padding: 8px;
            text-align: center;
        }

        .point-input {
            width: 60px;
            padding: 4px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .stat-selector {
            margin-bottom: 10px;
        }

        .stat-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .point-value-row {
            margin-bottom: 5px;
        }

        .stat-nav {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-nav-label {
            font-weight: bold;
        }

        .stat-buttons {
            display: flex;
            gap: 10px;
        }

        .stat-button {
            padding: 8px 16px;
            background-color: #a0a0a0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .stat-button:hover {
            background-color: #15ff00;
        }

        .active {
            background-color: #15b61a;
            color: white;
        }

        .single-stat-config {
            margin-bottom: 20px;
        }

        .single-stat-config .config-table {
            width: auto;
            margin: 0 auto;
        }

        .action-cell {
            text-align: center;
        }

        .adjust-btn {
            margin: 0 5px;
            padding: 2px 5px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .adjust-btn:hover {
            background-color: #e0e0e0;
        }

        /* Weight Matrix Editor styles */
        .weight-matrix-container {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .weight-matrix-scroll {

        }

        .weight-matrix-table {
            width: 100%;
            border-collapse: collapse;
        }

        .weight-matrix-table th, .weight-matrix-table td {
            padding: 8px;
            text-align: center;
        }

        .weight-source-stat {
            font-weight: bold;
        }

        .weight-input {
            width: 50px;
            padding: 4px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .active-weight {
            background-color: #25a129;
            color: white;
        }

        .negative-weight {
            background-color: #a12525;
            color: white;
        }

        .weight-description {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .dependency-list {
            list-style-type: none;
            padding-left: 0;
        }

        .dependency-list li {
            margin-bottom: 5px;
        }

        /* Point calculation breakdown styles */
        .point-breakdown-toggle {
            cursor: pointer;
            text-align: center;
            margin-top: 2px;
            display: inline-block;
        }

        .breakdown-arrow {
            font-size: 10px;
            color: #555;
        }

        /* Update the point breakdown styles for left pane */
        .point-breakdown {
            width: auto;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 13px;
            margin-top: 10px;
        }

        .breakdown-header {
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            color: #45a049;
            font-size: 14px;
        }

        .breakdown-base {
            font-weight: bold;
            margin-bottom: 10px;
            background-color: #f5f5f5;
            padding: 5px 8px;
            border-radius: 3px;
        }

        /* Update the breakdown item styles for better alignment */
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px dotted #eee;
        }

        .breakdown-item span:first-child {
            flex: 1;
            text-align: left;
        }

        .breakdown-item span:nth-child(2) {
            flex: 0 0 30px;
            text-align: right;
        }

        .adjusted-value {
            color: #4CAF50;
            margin-left: 5px;
            font-weight: bold;
            flex: 0 0 50px;
            text-align: right;
        }

        .percentage-value {
            color: #888;
            font-size: 0.9em;
            margin-left: 5px;
            flex: 0 0 45px;
            text-align: right;
        }

        .breakdown-total {
            margin-top: 12px;
            border-top: 2px solid #ddd;
            padding-top: 8px;
            font-weight: bold;
            text-align: right;
            color: #333;
        }

        /* Capability Chart Styles */
        .capability-chart {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 13px;
        }

        .capability-chart-header {
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            color: #45a049;
            font-size: 14px;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 10px;
        }

        /* Pie Chart Styles */
        .capability-pie-chart {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 13px;
        }

        .pie-chart-container {
            position: relative;
            height: 220px;
            margin-top: 10px;
        }

        .matrix-info {
            margin-bottom: 10px;
            font-size: 0.8em;
            color: #555;
        }

        .weight-matrix-actions {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .save-weights-btn {
            background-color: #2196F3;
        }

        .save-weights-btn:hover {
            background-color: #0b7dda;
        }

        .reset-weights-btn {
        }

        .reset-weights-btn:hover {
        }

        .toggle-weights-btn {
            padding: 4px 8px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
        }

        .toggle-weights-btn:hover {
        }

        .active {
            background-color: #23aa28;
            color: white;
        }

        /* Three Column Layout */
        .three-column-layout {
            display: flex;
            gap: 20px; /* Space between columns */
            position: relative; /* For absolute positioning context */
            height: calc(100vh - 10px); /* Take up full viewport height minus header */
            overflow: hidden;
        }

        .left-pane, .right-pane {
            background-color: #e9e9e9; /* Placeholder background */
            padding: 15px;
            border-radius: 5px;
            height: fit-content; /* Adjust height based on content */
            position: fixed; /* Fix the position */
            top: 70px; /* Position below fixed header */
            max-height: calc(100vh - 100px); /* Viewport height minus header and padding */
            overflow-y: auto; /* Allow scrolling if content is too tall */
        }

        .left-pane {
            left: 20px; /* Match body padding */
            width: 280px; /* Increased width for breakdown */
        }

        .right-pane {
            right: 20px; /* Match body padding */
            width: 200px; /* Original width */
        }

        .center-pane {
            flex: 1; /* Grow to fill available space */
            margin: 0 220px 0 300px; /* Adjust left margin to account for wider left pane */
        }

        /* Table container for fixed positioning */
        .models-table-container {
            position: sticky;
            top: 70px; /* Exact position matching body padding-top */
            background-color: white;
            padding: 20px;
            border-radius: 5px 5px 0 0;
            z-index: 50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 0;
            width: 100%;
            box-sizing: border-box;
            overflow-x: auto; /* Allow horizontal scrolling if needed */
        }
        
        /* Table scrolling styles */
        .models-table-container table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed; /* Fixed layout for better column control */
        }
        
        /* Adjust column widths to be more compact */
        .models-table-container th:first-child, 
        .models-table-container td:first-child {
            width: 50px; /* Reduce the width of the first column (Points) */
        }
        
        .models-table-container th:nth-child(2), 
        .models-table-container td:nth-child(2) {
            width: 80px; /* Adjust width for the name column */
        }
        
        .models-table-container th:not(:first-child):not(:nth-child(2)):not(:last-child), 
        .models-table-container td:not(:first-child):not(:nth-child(2)):not(:last-child) {
            width: 35px; /* Make stat columns more compact */
        }
        
        .models-table-container th:last-child, 
        .models-table-container td:last-child {
            width: 60px; /* Adjust actions column */
        }
        
        .models-table-container thead {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
        }
        
        .models-table-container tbody {
            display: block;
            max-height: 140px; /* Height for approximately 3 rows */
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease;
            /* Custom scrollbar styling */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #aaa #f0f0f0; /* Firefox */
        }
        
        /* Webkit scrollbar styling (Chrome, Safari, Edge) */
        .models-table-container tbody::-webkit-scrollbar {
            width: 2px;
        }
        
        .models-table-container tbody::-webkit-scrollbar-track {
            background: #f0f0f0;
        }
        
        .models-table-container tbody::-webkit-scrollbar-thumb {
            background-color: #aaa;
            border-radius: 10px;
            border: 1px solid transparent;
        }
        
        .models-table-container tbody::-webkit-scrollbar-thumb:hover {
            background-color: #888;
        }
        
        /* Expanded table when point config is hidden */
        .point-config-hidden .models-table-container tbody {
            max-height: 600px; /* Show more rows when point config is hidden */
        }
        
        .models-table-container thead tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        .models-table-container tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        /* Ensure header styles are consistent */
        .models-table-container th {
            background-color: #d1d1d1;
            border: 1px solid #ddd;
            padding: 8px;
        }

        /* Create a spacer to prevent any content showing in gap */
        .header-table-spacer {
            height: 0;
            margin: 0;
            padding: 0;
            background-color: transparent;
        }

        /* Scrollable content area below the fixed table */
        .scrollable-content {
            background-color: white;
            border-radius: 0 0 5px 5px;
            margin-top: 50px; /* Space between fixed table and scrollable content */
            position: relative;
            top: 0;
            z-index: 40; /* Lower than the table container */
            overflow-y: auto; /* Allow scrolling */
            height: calc(60vh); /* Fixed height based on viewport minus header and table */
            padding-bottom: 1px; /* Add extra padding at bottom to ensure content is visible */
        }

        /* Add style for selected model */
        .selected-model {
            background-color: #e3f0e3 !important;
            border-left: 3px solid #45a049;
        }

        .left-pane h2 {
            color: #333;
            border-bottom: 2px solid #45a049;
            padding-bottom: 8px;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Grim Resolver</h1>
        <div class="header-buttons">
            <button class="export-btn" @click="exportModels">Export to CSV</button>
            <label class="import-btn" for="importInput">Import from CSV</label>
            <input type="file" id="importInput" accept=".csv" @change="importModels($event)">
        </div>
    </div>

    <div class="three-column-layout" x-data="{
        models: [
            {
                name: 'Imperial Guardsman',
                movement: 6,
                weaponSkill: 3,
                ballisticSkill: '4+',
                strength: 3,
                toughness: 3,
                wounds: 1,
                initiative: 3,
                attacks: 1,
                leadership: 7,
                save: '5+',
                invulnSave: '-'
            },
            {
                name: 'Space Marine',
                movement: 6,
                weaponSkill: 4,
                ballisticSkill: '3+',
                strength: 4,
                toughness: 4,
                wounds: 1,
                initiative: 4,
                attacks: 1,
                leadership: 8,
                save: '3+',
                invulnSave: '-'
            },
            {
                name: 'Terminator',
                movement: 5,
                weaponSkill: 4,
                ballisticSkill: '3+',
                strength: 4,
                toughness: 4,
                wounds: 1,
                initiative: 1,
                attacks: 2,
                leadership: 8,
                save: '2+',
                invulnSave: '5+'
            },
            {
                name: 'Ork Warboy',
                movement: 5,
                weaponSkill: 4,
                ballisticSkill: '5+',
                strength: 3,
                toughness: 4,
                wounds: 1,
                initiative: 2,
                attacks: 2,
                leadership: 6,
                save: '6+',
                invulnSave: '-'
            },
            {
                name: 'Eldar Guardian',
                movement: 6,
                weaponSkill: 4,
                ballisticSkill: '3+',
                strength: 3,
                toughness: 3,
                wounds: 1,
                initiative: 5,
                attacks: 1,
                leadership: 8,
                save: '5+',
                invulnSave: '-'
            }
        ],
        selectedModel: null,
        showPointConfig: true,
        currentStat: 'weights',
        
        // Point value lookup tables for each stat
        pointValueLookups: {
            movement: {
                1: -2,
                2: -1,
                3: 0,
                4: 1,
                5: 2,
                6: 3,
                7: 4,
                8: 5,
                9: 6,
                10: 7,
                11: 8,
                12: 9
            },
            weaponSkill: {
                1: 0,
                2: 1,
                3: 2,
                4: 3,
                5: 5,
                6: 6,
                7: 7,
                8: 8,
                9: 9,
                10: 10
            },
            ballisticSkill: {
                '2+': 12,
                '3+': 9,
                '4+': 6,
                '5+': 3,
                '6+': 1,
                '-': 0
            },
            strength: {
                1: -1,
                2: 0,
                3: 1,
                4: 2,
                5: 5,
                6: 8,
                7: 11,
                8: 12,
                9: 13,
                10: 14
            },
            toughness: {
                1: -5,
                2: -2,
                3: 1,
                4: 4,
                5: 7,
                6: 10,
                7: 13,
                8: 16,
                9: 19,
                10: 22
            },
            wounds: {
                1: 0,
                2: 5,
                3: 10,
                4: 15,
                5: 20,
                6: 25,
                7: 30,
                8: 35,
                9: 40,
                10: 45
            },
            initiative: {
                1: -3,
                2: -1,
                3: 0,
                4: 1,
                5: 3,
                6: 5,
                7: 7,
                8: 10,
                9: 13,
                10: 16
            },
            attacks: {
                1: 1,
                2: 4,
                3: 8,
                4: 12,
                5: 16,
                6: 20,
                7: 24,
                8: 28,
                9: 32,
                10: 36
            },
            leadership: {
                1: -5,
                2: -4,
                3: -3,
                4: -2,
                5: -1,
                6: 0,
                7: 1,
                8: 2,
                9: 3,
                10: 4
            },
            save: {
                '2+': 16,
                '3+': 8,
                '4+': 4,
                '5+': 2,
                '6+': 1,
                '-': 0
            },
            invulnSave: {
                '2+': 100,
                '3+': 50,
                '4+': 20,
                '5+': 10,
                '6+': 5,
                '-': 0
            }
        },

        // Add stat multipliers, defaulting to 1.0
        statMultipliers: {
            movement: 1.0,
            weaponSkill: 1.0,
            ballisticSkill: 1.0,
            strength: 1.0,
            toughness: 1.0,
            wounds: 1.0,
            initiative: 1.0,
            attacks: 1.0,
            leadership: 1.0,
            save: 1.0,
            invulnSave: 1.0
        },

        // Calculate background color based on multiplier value
        getMultiplierColor(value) {
            // Define our color range
            const colors = {
                0: { r: 227, g: 235, b: 190 },    // Lightest yellow at 0
                1: { r: 145, g: 225, b: 170 },     // Medium green at 1
                2: { r: 40, g: 215, b: 60 }       // Darkest green at 2
            };
            
            // Cap the value between 0 and 2
            const clampedValue = Math.max(0, Math.min(2, value));
            
            // Determine which color pair to interpolate between
            let lowerColor, upperColor, lowerValue, upperValue;
            
            if (clampedValue <= 1) {
                lowerValue = 0;
                upperValue = 1;
                lowerColor = colors[0];
                upperColor = colors[1];
            } else {
                lowerValue = 1;
                upperValue = 2;
                lowerColor = colors[1];
                upperColor = colors[2];
            }
            
            // Calculate interpolation factor
            const factor = (clampedValue - lowerValue) / (upperValue - lowerValue);
            
            // Interpolate RGB values
            const r = Math.round(lowerColor.r + factor * (upperColor.r - lowerColor.r));
            const g = Math.round(lowerColor.g + factor * (upperColor.g - lowerColor.g));
            const b = Math.round(lowerColor.b + factor * (upperColor.b - lowerColor.b));
            
            // Return RGB color string
            return `rgb(${r}, ${g}, ${b})`;
        },

        // Initialize the component
        init() {
            // Load saved point values if they exist
            const savedPointValues = localStorage.getItem('pointValueLookups');
            if (savedPointValues) {
                this.pointValueLookups = JSON.parse(savedPointValues);
            }
            
            // Load saved weight matrix if it exists
            const savedWeightMatrix = localStorage.getItem('statWeightMatrix');
            if (savedWeightMatrix) {
                this.statWeightMatrix = JSON.parse(savedWeightMatrix);
            }

            // Load saved stat multipliers if they exist
            const savedStatMultipliers = localStorage.getItem('statMultipliers');
            if (savedStatMultipliers) {
                this.statMultipliers = JSON.parse(savedStatMultipliers);
            } else {
                // Ensure default multipliers are set if not found in storage
                this.statMultipliers = {
                    movement: 1.0, weaponSkill: 1.0, ballisticSkill: 1.25, strength: 1.0,
                    toughness: 1.0, wounds: 1.0, initiative: 1.0, attacks: 1.0,
                    leadership: 1.0, save: 1.5, invulnSave: 1.0
                };
            }

            // Initialize the first model as selected by default
            if (this.models.length > 0) {
                this.selectedModel = this.models[0];
            }
        },
        
        addModel() {
            const lastModel = this.models[this.models.length - 1];
            const newModel = {
                name: lastModel.name,
                movement: lastModel.movement,
                weaponSkill: lastModel.weaponSkill,
                ballisticSkill: lastModel.ballisticSkill,
                strength: lastModel.strength,
                toughness: lastModel.toughness,
                wounds: lastModel.wounds,
                initiative: lastModel.initiative,
                attacks: lastModel.attacks,
                leadership: lastModel.leadership,
                save: lastModel.save,
                invulnSave: lastModel.invulnSave
            };
            this.models.push(newModel);
            this.selectedModel = newModel; // Select the newly added model
        },
        
        duplicateModel(index) {
            const modelToDuplicate = this.models[index];
            const newModel = {
                name: modelToDuplicate.name,
                movement: modelToDuplicate.movement,
                weaponSkill: modelToDuplicate.weaponSkill,
                ballisticSkill: modelToDuplicate.ballisticSkill,
                strength: modelToDuplicate.strength,
                toughness: modelToDuplicate.toughness,
                wounds: modelToDuplicate.wounds,
                initiative: modelToDuplicate.initiative,
                attacks: modelToDuplicate.attacks,
                leadership: modelToDuplicate.leadership,
                save: modelToDuplicate.save,
                invulnSave: modelToDuplicate.invulnSave
            };
            this.models.splice(index + 1, 0, newModel);
            this.selectedModel = newModel; // Select the newly duplicated model
        },
        
        removeModel(index) {
            if (this.models.length > 1) {
                if (confirm('Are you sure you want to delete this model?')) {
                    // Check if the selected model is the one being removed
                    const modelToRemove = this.models[index];
                    const isSelectedModel = this.selectedModel === modelToRemove;
                    
                    // Remove the model
                    this.models.splice(index, 1);
                    
                    // If the selected model was removed, select the first model
                    if (isSelectedModel) {
                        this.selectedModel = this.models[0];
                    }
                }
            }
        },
        
        calculatePoints(model) {
            // Phase 1: Calculate base values
            const baseValues = {
                movement: this.getBasePoints('movement', model.movement),
                weaponSkill: this.getBasePoints('weaponSkill', model.weaponSkill),
                ballisticSkill: this.getBasePoints('ballisticSkill', model.ballisticSkill),
                strength: this.getBasePoints('strength', model.strength),
                toughness: this.getBasePoints('toughness', model.toughness),
                wounds: this.getBasePoints('wounds', model.wounds),
                initiative: this.getBasePoints('initiative', model.initiative),
                attacks: this.getBasePoints('attacks', model.attacks),
                leadership: this.getBasePoints('leadership', model.leadership),
                save: this.getBasePoints('save', model.save),
                invulnSave: this.getBasePoints('invulnSave', model.invulnSave)
            };
            
            // Phase 2: Apply weight matrix adjustments
            const adjustedValues = this.applyWeightMatrix(baseValues, model);
            
            // Return raw total points
            return 10 + Object.values(adjustedValues).reduce((a, b) => a + b, 0);
        },

        getPointBreakdown(model) {
            // Phase 1: Calculate base values
            const baseValues = {
                movement: this.getBasePoints('movement', model.movement),
                weaponSkill: this.getBasePoints('weaponSkill', model.weaponSkill),
                ballisticSkill: this.getBasePoints('ballisticSkill', model.ballisticSkill),
                strength: this.getBasePoints('strength', model.strength),
                toughness: this.getBasePoints('toughness', model.toughness),
                wounds: this.getBasePoints('wounds', model.wounds),
                initiative: this.getBasePoints('initiative', model.initiative),
                attacks: this.getBasePoints('attacks', model.attacks),
                leadership: this.getBasePoints('leadership', model.leadership),
                save: this.getBasePoints('save', model.save),
                invulnSave: this.getBasePoints('invulnSave', model.invulnSave)
            };
            
            // Phase 2: Apply weight matrix adjustments
            const adjustedValues = this.applyWeightMatrix(baseValues, model);
            
            // Return calculation details
            return {
                baseValues: {...baseValues},
                adjustedValues: {...adjustedValues},
                total: 10 + Object.values(adjustedValues).reduce((a, b) => a + b, 0)
            };
        },

        getRelativePoints(model, index) {
            if (index === 0) {
                return (5).toFixed(2); // First model is always 5, ensure consistent formatting
            }
            if (this.models.length < 1) {
                return '-'; // Should not happen, but safeguard
            }

            const firstModelPoints = this.calculatePoints(this.models[0]);
            const currentModelPoints = this.calculatePoints(model);

            if (firstModelPoints <= 0) { // Check for <= 0 to handle negative points safely
                return '-'; // Avoid division by zero or negative base
            }

            return ((currentModelPoints / firstModelPoints) * 5).toFixed(2); // Calculate relative points, rounded
        },
        
        getTotalPoints() {
            return this.models.reduce((total, model) => total + this.calculatePoints(model), 0);
        },
        
        // Point value functions that use the lookup tables
        getMovementPoints(value) {
            return this.pointValueLookups.movement[value];
        },
        
        getWeaponSkillPoints(value) {
            return this.pointValueLookups.weaponSkill[value];
        },
        
        getBallisticSkillPoints(value) {
            if (!value || value === '-') {
                return this.pointValueLookups.ballisticSkill['-'];
            }
            // Parse the value, removing the '+' if present
            const parsedValue = value.replace('+', '');
            return this.pointValueLookups.ballisticSkill[parsedValue + '+'];
        },
        
        getStrengthPoints(value) {
            return this.pointValueLookups.strength[value];
        },
        
        getToughnessPoints(value) {
            return this.pointValueLookups.toughness[value];
        },
        
        getWoundsPoints(value) {
            return this.pointValueLookups.wounds[value];
        },
        
        getInitiativePoints(value) {
            return this.pointValueLookups.initiative[value];
        },
        
        getAttacksPoints(value) {
            return this.pointValueLookups.attacks[value];
        },
        
        getLeadershipPoints(value) {
            return this.pointValueLookups.leadership[value];
        },
        
        getSavePoints(value) {
            if (!value || value === '-') {
                return this.pointValueLookups.save['-'];
            }
            // Parse the value, removing the '+' if present
            const parsedValue = value.replace('+', '');
            return this.pointValueLookups.save[parsedValue + '+'];
        },
        
        getInvulnSavePoints(value) {
            if (!value || value === '-') {
                return this.pointValueLookups.invulnSave['-'];
            }
            // Parse the value, removing the '+' if present
            const parsedValue = value.replace('+', '');
            return this.pointValueLookups.invulnSave[parsedValue + '+'];
        },

        // Simple function to ensure skill values always have a + sign
        ensurePlusSign(model, prop) {
            if (!model[prop].includes('+') && !model[prop].includes('-')) {
                model[prop] = model[prop] + '+';
            }
        },        // Function to increment numeric skill value
        incrementNumeric(model, prop) {
            const maxValue = prop === 'movement' ? 12 : 10;  // Movement caps at 12, others at 10
            if (model[prop] < maxValue) {
                model[prop]++;
            }
        },
        // Function to decrement numeric skill value
        decrementNumeric(model, prop) {
            if (model[prop] > 1) {  // Floor at 1
                model[prop]--;
            }
        },
        // Function to increment skill value with plus sign
        incrementSkill(model, prop) {
            if (model[prop] === '6+') {
                model[prop] = '-';  // When reaching beyond 6+, use dash
                return;
            }
            
            if (model[prop] === '-') {
                return;  // Dash is the maximum, can't increment further
            }
            
            const value = parseInt(model[prop]);
            if (!isNaN(value) && value < 6) {  // Cap at 6+
                model[prop] = (value + 1) + '+';
            }
        },
        // Function to decrement skill value with plus sign
        decrementSkill(model, prop) {
            if (model[prop] === '-') {
                model[prop] = '6+';  // Go back to 6+ when decrementing from dash
                return;
            }
            
            const value = parseInt(model[prop]);
            if (!isNaN(value) && value > 2) {  // Floor at 2+
                model[prop] = (value - 1) + '+';
            }
        },
        
        // Export models to CSV
        exportModels() {
            // CSV header
            let csv = 'Name,Movement,Weapon Skill,Ballistic Skill,Strength,Toughness,Wounds,Initiative,Attacks,Leadership,Save,Invuln Save\n';
            
            // Add each model as a row
            this.models.forEach(model => {
                csv += [
                    model.name || 'Unnamed',
                    model.movement,
                    model.weaponSkill,
                    model.ballisticSkill,
                    model.strength,
                    model.toughness,
                    model.wounds,
                    model.initiative,
                    model.attacks,
                    model.leadership,
                    model.save,
                    model.invulnSave
                ].join(',') + '\n';
            });
            
            // Create a blob and download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'grim_resolver_models.csv');
            a.click();
            URL.revokeObjectURL(url);
        },
        
        // Import models from CSV
        importModels(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    // Parse CSV content
                    const lines = e.target.result.split('\n');
                    // Skip header row
                    const modelLines = lines.slice(1).filter(line => line.trim());
                    
                    if (modelLines.length === 0) return;
                    
                    // Convert CSV rows to model objects
                    const importedModels = modelLines.map(line => {
                        const values = line.split(',');
                        return {
                            name: values[0] === 'Unnamed' ? '' : values[0],
                            movement: parseInt(values[1]),
                            weaponSkill: parseInt(values[2]),
                            ballisticSkill: values[3],
                            strength: parseInt(values[4]),
                            toughness: parseInt(values[5]),
                            wounds: parseInt(values[6]),
                            initiative: parseInt(values[7]),
                            attacks: parseInt(values[8]),
                            leadership: parseInt(values[9]),
                            save: values[10],
                            invulnSave: values[11]
                        };
                    });
                    
                    // Replace current models with imported ones
                    this.models = importedModels;
                    
                    // Select the first imported model
                    if (this.models.length > 0) {
                        this.selectedModel = this.models[0];
                    }
                } catch (error) {
                    alert('Error importing the file. Make sure it is a valid CSV.');
                    console.error('Import error:', error);
                }
                
                // Clear file input
                event.target.value = '';
            };
            reader.readAsText(file);
        },

        // Export point values to JSON
        exportPointValues() {
            console.log(this.pointValueLookups);
            const dataToExport = {
                pointValueLookups: this.pointValueLookups,
                statMultipliers: this.statMultipliers // Include multipliers in export
            };
            
            // Include weight matrix if option is enabled
            if (this.includeWeightMatrixInExport) {
                dataToExport.statWeightMatrix = this.statWeightMatrix;
            }
            
            const data = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'point_values.json');
            a.click();
            URL.revokeObjectURL(url);
        },

        // Import point values from JSON
        importPointValues(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Validate point value lookups
                    if (imported.pointValueLookups) {
                        const requiredStats = [
                            'movement', 'weaponSkill', 'ballisticSkill', 'strength',
                            'toughness', 'wounds', 'initiative', 'attacks', 'leadership', 'save', 'invulnSave'
                        ];
                        
                        if (requiredStats.every(stat => imported.pointValueLookups[stat])) {
                            this.pointValueLookups = imported.pointValueLookups;
                            localStorage.setItem('pointValueLookups', JSON.stringify(imported.pointValueLookups));
                            
                            // Import stat multipliers if available
                            if (imported.statMultipliers) {
                                this.statMultipliers = imported.statMultipliers;
                                localStorage.setItem('statMultipliers', JSON.stringify(imported.statMultipliers));
                            } else {
                                // Reset to default if not found in imported file
                                this.statMultipliers = {
                                    movement: 1.0, weaponSkill: 1.0, ballisticSkill: 1.0, strength: 1.0,
                                    toughness: 1.0, wounds: 1.0, initiative: 1.0, attacks: 1.0,
                                    leadership: 1.0, save: 1.0, invulnSave: 1.0
                                };
                                localStorage.removeItem('statMultipliers'); // Remove potentially old value
                            }

                            // Import weight matrix if available
                            if (imported.statWeightMatrix) {
                                if (confirm('The imported file contains a weight matrix. Do you want to import it as well?')) {
                                    this.statWeightMatrix = imported.statWeightMatrix;
                                    localStorage.setItem('statWeightMatrix', JSON.stringify(imported.statWeightMatrix));
                                }
                            }
                            
                            alert('Point values imported successfully!');
                        } else {
                            alert('Invalid point values file. Missing required stats.');
                        }
                    } else {
                        alert('Invalid point values file. Missing pointValueLookups object.');
                    }
                } catch (error) {
                    alert('Error importing point values. Make sure it is a valid JSON file.');
                    console.error('Import error:', error);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        },

        formatStatName(stat) {
            return stat.charAt(0).toUpperCase() + stat.slice(1).replace(/([A-Z])/g, ' $1');
        },

        statWeightMatrix: {
            // Effect of row stat on column stat
            //           M    WS   BS   S    T    W    I    A    Ld   Sv   Inv
            movement:   [0,  .1,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Movement affects Initiative and Attacks
            weaponSkill:[0,   0, -.2,   0,   0,   0,  .2,  .5,   0,   0,   0],   // WS affects Strength, Initiative and Attacks
            ballisticSkill:[0,0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
            strength:   [0,   0,   0,   0,   0,   0,   0,  .5,   0,   0,   0],   // Strength is a terminal node
            toughness:  [0,   0,   0,   0,   0,  .1,   0,   0,   0,   0,   0],   // T affects Wounds and Leadership
            wounds:     [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Wounds is a terminal node
            initiative: [0,   0,   0,   0,   0,   0,   0,  .2,   0,   0,   0],   // Initiative affects Attacks
            attacks:    [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Attacks affects Strength
            leadership: [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Leadership is a terminal node
            save:       [0,   0,   0,   0,   0,  .5,   0,   0,   0,   0,   0],   // Save affects Wounds
            invulnSave: [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0]    // Invuln Save affects Wounds
        },

        applyWeightMatrix(baseValues, model) {
            const statOrder = ['movement', 'weaponSkill', 'ballisticSkill', 'strength', 
                               'toughness', 'wounds', 'initiative', 'attacks', 'leadership', 'save', 'invulnSave'];
            const adjustedValues = {...baseValues};
            
            // Apply adjustments in correct order
            for (const [targetIdx, targetStat] of statOrder.entries()) {
                let adjustment = 0;
                
                // Calculate influence from each source stat
                for (const sourceStat of statOrder) {
                    // Get the weight from source stat to target stat
                    const weight = this.statWeightMatrix[sourceStat][targetIdx];
                    
                    if (weight !== 0) {
                        // Use raw stat value to determine influence
                        const rawValue = model[sourceStat];
                        const baseValue = baseValues[sourceStat];
                        adjustment += this.calculateInfluence(baseValue, weight, sourceStat);
                    }
                }
                
                // Apply adjustment by direct addition instead of as a multiplier
                adjustedValues[targetStat] = baseValues[targetStat] + adjustment;
            }
            
            return adjustedValues;
        },

        calculateInfluence(rawValue, weight, sourceStat) {
            return weight * rawValue;
        },

        getBasePoints(stat, value) {
            let baseValue;
            // Handle special cases for stats with plus signs
            if (['ballisticSkill', 'save', 'invulnSave'].includes(stat)) {
                if (!value || value === '-') {
                    baseValue = this.pointValueLookups[stat]['-'];
                } else {
                    // Parse the value, removing the '+' if present
                    const parsedValue = value.replace('+', '');
                    baseValue = this.pointValueLookups[stat][parsedValue + '+'];
                }
            } else {
                // For regular numeric stats
                baseValue = this.pointValueLookups[stat][value];
            }
            
            // Apply multiplier to all stats, including skill-based ones
            const multiplier = this.statMultipliers[stat] || 1.0; // Get multiplier, default to 1 if undefined
            return baseValue * multiplier; // Apply multiplier
        },

        getStatShortName(stat) {
            const shortNames = {
                movement: 'M',
                weaponSkill: 'WS',
                ballisticSkill: 'BS',
                strength: 'S',
                toughness: 'T',
                wounds: 'W',
                initiative: 'I',
                attacks: 'A',
                leadership: 'Ld',
                save: 'Sv',
                invulnSave: 'Inv'
            };
            return shortNames[stat] || stat;
        },

        getStatAtIndex(index) {
            const stats = ['movement', 'weaponSkill', 'ballisticSkill', 'strength', 'toughness', 'wounds', 'initiative', 'attacks', 'leadership', 'save', 'invulnSave'];
            return stats[index];
        },

        // Save the current weight matrix to localStorage
        saveWeightMatrix() {
            localStorage.setItem('statWeightMatrix', JSON.stringify(this.statWeightMatrix));
            alert('Weight matrix saved successfully!');
        },

        // Reset the weight matrix to default values
        resetWeightMatrix() {
            if (confirm('Are you sure you want to reset the weight matrix to default values?')) {
                this.statWeightMatrix = {
                    // Effect of row stat on column stat
                    //           M    WS   BS   S    T    W    I    A    Ld   Sv   Inv
                    movement:   [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Movement affects Initiative and Attacks
                    weaponSkill:[0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // WS affects Strength, Initiative and Attacks
                    ballisticSkill:[0,0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
                    strength:   [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Strength is a terminal node
                    toughness:  [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // T affects Wounds and Leadership
                    wounds:     [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Wounds is a terminal node
                    initiative: [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Initiative affects Attacks
                    attacks:    [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Attacks affects Strength
                    leadership: [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Leadership is a terminal node
                    save:       [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],   // Save affects Wounds
                    invulnSave: [0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0]    // Invuln Save affects Wounds
                };
            }
        },

        includeWeightMatrixInExport: false,

        // Get capabilities for the selected model
        getCapabilities(model) {
            // First get the point breakdown with all adjusted values
            const breakdown = this.getPointBreakdown(model);
            const adjustedValues = breakdown.adjustedValues;
            
            // Calculate each capability
            const shooting = Math.max(0, adjustedValues.ballisticSkill);
            
            const combat = Math.max(0, 
                adjustedValues.weaponSkill + 
                adjustedValues.strength + 
                adjustedValues.attacks +
                adjustedValues.initiative
            );
            
            const defense = Math.max(0, 
                adjustedValues.toughness + 
                adjustedValues.save + 
                adjustedValues.invulnSave +
                adjustedValues.wounds
            );
            
            const movement = Math.max(0, adjustedValues.movement);
            
            const other = Math.max(0, adjustedValues.leadership);
            
            return {
                shooting,
                combat,
                defense,
                movement,
                other
            };
        }
    }">
        <div class="left-pane">
            <h2>Point Breakdown</h2>
            <div x-data="{ 
                capabilities: selectedModel ? getCapabilities(selectedModel) : null,
                breakdown: selectedModel ? getPointBreakdown(selectedModel) : null,
                chart: null,
                pieChart: null
            }"
            x-effect="capabilities = selectedModel ? getCapabilities(selectedModel) : null; 
                      breakdown = selectedModel ? getPointBreakdown(selectedModel) : null;">
                
                <!-- Point Breakdown Section -->
                <div class="point-breakdown" x-show="selectedModel !== null">
                    <div class="breakdown-header">Absolute Point Calculation:</div>
                    <div class="breakdown-base">Base Cost: 10</div>
                    <template x-if="breakdown">
                        <template x-for="(baseValue, stat) in breakdown.baseValues" :key="stat">
                            <div class="breakdown-item">
                                <span x-text="formatStatName(stat) + ':'"></span>
                                <span x-text="baseValue.toFixed(1)"></span>
                                <template x-if="Math.abs(breakdown.adjustedValues[stat] - baseValue) > 0.1">
                                    <span class="adjusted-value" 
                                        x-text="'  ' + breakdown.adjustedValues[stat].toFixed(1)"></span>
                                </template>
                                <!-- Add percentage contribution calculation -->
                                <span class="percentage-value" 
                                      x-text="' (' + Math.round((breakdown.adjustedValues[stat] / (breakdown.total - 10)) * 100) + '%)'"></span>
                            </div>
                        </template>
                        <div class="breakdown-total">
                            Absolute Total: <span x-text="breakdown.total.toFixed(1)"></span>
                        </div>
                    </template>
                    <template x-if="!breakdown">
                        <div>Select a model to see breakdown</div>
                    </template>
                </div>

                <!-- Capability Bar Chart -->
                <div class="capability-chart" x-show="selectedModel !== null"
                    x-init="$watch('capabilities', (value) => { 
                        if (value) {
                            if (chart) chart.destroy();
                            const ctx = $refs.capabilityCanvas.getContext('2d');
                            
                            // Calculate the maximum value for the y-axis
                            const dataValues = [
                                value.shooting,
                                value.combat,
                                value.defense,
                                value.movement,
                                value.other
                            ];
                            const maxValue = Math.max(...dataValues);
                            const yAxisMax = Math.max(20, Math.ceil(maxValue * 1.1)); // At least 20, with 10% headroom
                            
                            chart = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: ['Shooting', 'Combat', 'Defense', 'Movement', 'Other'],
                                    datasets: [{
                                        label: 'Capability Points',
                                        data: dataValues,
                                        backgroundColor: [
                                            'rgba(255, 120, 0, 0.8)',   // Fiery orange (Shooting)
                                            'rgba(180, 20, 20, 0.8)',    // Blood red (Combat)
                                            'rgba(70, 130, 180, 0.8)',   // Steel blue (Defense)
                                            'rgba(50, 200, 100, 0.8)',    // Swift green (Movement)
                                            'rgba(199, 21, 133, 0.8)'    // Bright pinkish purple (Other)
                                        ],
                                        borderColor: [
                                            'rgba(255, 120, 0, 1)',     // Fiery orange (Shooting)
                                            'rgba(180, 20, 20, 1)',      // Blood red (Combat)
                                            'rgba(70, 130, 180, 1)',     // Steel blue (Defense)
                                            'rgba(50, 200, 100, 1)',      // Swift green (Movement)
                                            'rgba(199, 21, 133, 1)'      // Bright pinkish purple (Other)
                                        ],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: {
                                        duration: 0 // Set animation duration to 0 to make it instant
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: yAxisMax,
                                            grid: {
                                                color: 'rgba(0, 0, 0, 0.1)'
                                            },
                                            ticks: {
                                                stepSize: 5
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    return context.parsed.y.toFixed(1) + ' points';
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });">
                    <div class="capability-chart-header">Capability Costs:</div>
                    <template x-if="capabilities">
                        <div class="chart-container">
                            <canvas x-ref="capabilityCanvas"></canvas>
                        </div>
                    </template>
                    <template x-if="!capabilities">
                        <div>Select a model to see capabilities</div>
                    </template>
                </div>

                <!-- Capability Pie Chart -->
                <div class="capability-pie-chart" x-show="selectedModel !== null"
                    x-init="$watch('capabilities', (value) => { 
                        if (value) {
                            if (pieChart) pieChart.destroy();
                            const pieCtx = $refs.pieCanvas.getContext('2d');
                            
                            pieChart = new Chart(pieCtx, {
                                type: 'pie',
                                data: {
                                    labels: ['Shooting', 'Combat', 'Defense', 'Movement', 'Other'],
                                    datasets: [{
                                        data: [
                                            value.shooting,
                                            value.combat,
                                            value.defense,
                                            value.movement,
                                            value.other
                                        ],
                                        backgroundColor: [
                                            'rgba(255, 120, 0, 0.8)',   // Fiery orange (Shooting)
                                            'rgba(180, 20, 20, 0.8)',    // Blood red (Combat)
                                            'rgba(70, 130, 180, 0.8)',   // Steel blue (Defense)
                                            'rgba(50, 200, 100, 0.8)',    // Swift green (Movement)
                                            'rgba(199, 21, 133, 0.8)'    // Bright pinkish purple (Other)
                                        ],
                                        borderColor: [
                                            'rgba(255, 120, 0, 1)',     // Fiery orange (Shooting)
                                            'rgba(180, 20, 20, 1)',      // Blood red (Combat)
                                            'rgba(70, 130, 180, 1)',     // Steel blue (Defense)
                                            'rgba(50, 200, 100, 1)',      // Swift green (Movement)
                                            'rgba(199, 21, 133, 1)'      // Bright pinkish purple (Other)
                                        ],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: {
                                        duration: 0 // Make animation instant
                                    },
                                    plugins: {
                                        legend: {
                                            position: 'right',
                                            labels: {
                                                font: {
                                                    size: 11
                                                }
                                            }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const value = context.parsed;
                                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                    const percentage = Math.round((value * 100) / total);
                                                    return `${value.toFixed(1)} points (${percentage}%)`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });">
                    <div class="capability-chart-header">Cost Distribution:</div>
                    <template x-if="capabilities">
                        <div class="pie-chart-container">
                            <canvas x-ref="pieCanvas"></canvas>
                        </div>
                    </template>
                    <template x-if="!capabilities">
                        <div>Select a model to see capability distribution</div>
                    </template>
                </div>
            </div>
        </div>

        <div class="center-pane">
            <div :class="{'point-config-hidden': !showPointConfig}">
                <div class="models-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="tooltip" data-tooltip="Points cost">Pts</th>
                                <th>Name</th>
                                <th class="tooltip" data-tooltip="Movement: How far the model can move in inches">M</th>
                                <th class="tooltip" data-tooltip="Weapon Skill: Ability in close combat">WS</th>
                                <th class="tooltip" data-tooltip="Ballistic Skill: Accuracy with ranged weapons (lower is better)">BS</th>
                                <th class="tooltip" data-tooltip="Strength: Physical power of the model in combat">S</th>
                                <th class="tooltip" data-tooltip="Toughness: Difficulty to wound the model">T</th>
                                <th class="tooltip" data-tooltip="Wounds: Amount of damage the model can sustain">W</th>
                                <th class="tooltip" data-tooltip="Initiative: Speed and combat reaction time">I</th>
                                <th class="tooltip" data-tooltip="Attacks: Number of close combat attacks">A</th>
                                <th class="tooltip" data-tooltip="Leadership: Bravery and morale of the model">Ld</th>
                                <th class="tooltip" data-tooltip="Save: Armor save value (lower is better)">Sv</th>
                                <th class="tooltip" data-tooltip="Invulnerable Save: Special save that cannot be modified (lower is better)">Inv</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(model, index) in models" :key="index">
                                <tr >
                                    <td @click="selectedModel = model" :class="{'selected-model': selectedModel === model}">
                                        <span style="display: inline-block; cursor: pointer;" x-text="getRelativePoints(model, index)"></span>
                                        <span x-text="selectedModel === model ? '' : ''" class="breakdown-arrow"></span>
                                    </td>
                                    <td><input type="text" x-model="model.name" placeholder="Model name"></td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="number" x-model.number="model.movement" min="1" max="12">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementNumeric(model, 'movement')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementNumeric(model, 'movement')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="number" x-model.number="model.weaponSkill" min="1" max="10">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementNumeric(model, 'weaponSkill')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementNumeric(model, 'weaponSkill')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="text" x-model="model.ballisticSkill" @blur="ensurePlusSign(model, 'ballisticSkill')">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementSkill(model, 'ballisticSkill')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementSkill(model, 'ballisticSkill')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="number" x-model.number="model.strength" min="1" max="10">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementNumeric(model, 'strength')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementNumeric(model, 'strength')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="number" x-model.number="model.toughness" min="1" max="10">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementNumeric(model, 'toughness')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementNumeric(model, 'toughness')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="number" x-model.number="model.wounds" min="1" max="10">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementNumeric(model, 'wounds')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementNumeric(model, 'wounds')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="number" x-model.number="model.initiative" min="1" max="10">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementNumeric(model, 'initiative')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementNumeric(model, 'initiative')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="number" x-model.number="model.attacks" min="1" max="10">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementNumeric(model, 'attacks')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementNumeric(model, 'attacks')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="number" x-model.number="model.leadership" min="1" max="10">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementNumeric(model, 'leadership')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementNumeric(model, 'leadership')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="text" x-model="model.save" @blur="ensurePlusSign(model, 'save')">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementSkill(model, 'save')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementSkill(model, 'save')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skill-input-wrapper">
                                            <input type="text" x-model="model.invulnSave" @blur="ensurePlusSign(model, 'invulnSave')">
                                            <div class="spinner-buttons">
                                                <button class="spinner-button" @click="incrementSkill(model, 'invulnSave')" title="Increase"></button>
                                                <button class="spinner-button" @click="decrementSkill(model, 'invulnSave')" title="Decrease"></button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="delete-btn tooltip" @click="removeModel(index)" :disabled="models.length === 1" data-tooltip="Delete this model">X</button>
                                        <button class="tooltip" @click="duplicateModel(index)" data-tooltip="Create a copy of this model">C</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div class="import-export-container">
                    </div>
                    
                    <div class="total-points hidden">
                        Total Points: <span x-text="getTotalPoints()"></span>
                    </div>
                    
                    <button @click="showPointConfig = !showPointConfig" class="config-btn">
                        <span x-text="showPointConfig ? 'Hide Point Matrix' : 'Show Point Matrix'"></span>
                        <span class="arrow-icon" :class="{'arrow-up': !showPointConfig}"></span>
                    </button>
                </div>
                
                <div class="scrollable-content">
                    <div x-show="showPointConfig" class="point-config-tables">
                        <div class="point-config-header">
                            <h3>Point Value Configuration</h3>
                            <div class="point-config-actions">
                                <button @click="exportPointValues" class="export-btn">Export Configuration</button>
                                <label class="import-btn" for="importPointValues">Import Configuration</label>
                                <input type="file" id="importPointValues" @change="importPointValues($event)" accept=".json">
                            </div>
                        </div>

                        <div class="stat-nav">
                            <div class="stat-nav-label">Current Stat:</div>
                            <div class="stat-buttons">
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'movement'"
                                    x-bind:class="{'active': currentStat === 'movement'}">M</button>
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'weaponSkill'"
                                    x-bind:class="{'active': currentStat === 'weaponSkill'}">WS</button>
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'ballisticSkill'"
                                    x-bind:class="{'active': currentStat === 'ballisticSkill'}">BS</button>
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'strength'"
                                    x-bind:class="{'active': currentStat === 'strength'}">S</button>
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'toughness'"
                                    x-bind:class="{'active': currentStat === 'toughness'}">T</button>
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'wounds'"
                                    x-bind:class="{'active': currentStat === 'wounds'}">W</button>
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'attacks'"
                                    x-bind:class="{'active': currentStat === 'attacks'}">A</button>
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'leadership'"
                                    x-bind:class="{'active': currentStat === 'leadership'}">Ld</button>
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'save'"
                                    x-bind:class="{'active': currentStat === 'save'}">Sv</button>
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'invulnSave'"
                                    x-bind:class="{'active': currentStat === 'invulnSave'}">Inv</button>
                                <button 
                                    class="stat-button" 
                                    x-on:click="currentStat = 'weights'"
                                    x-bind:class="{'active': currentStat === 'weights'}">Weights</button>
                            </div>
                        </div>

                        <div class="single-stat-config" x-show="currentStat !== 'weights'">
                            <h4>
                                <span x-text="formatStatName(currentStat)"></span>
                                <span> Multiplier: </span>
                                <input type="number"
                                       x-model.number="statMultipliers[currentStat]"
                                       min="0"
                                       step="0.1"
                                       class="weight-input"
                                       @input="$nextTick(() => $forceUpdate())"
                                       :style="{ backgroundColor: getMultiplierColor(statMultipliers[currentStat]) }">
                            </h4>
                            <table class="config-table">
                                <tr>
                                    <th>Value</th>
                                    <th>Points</th>
                                    <th>Scaled</th>
                                </tr>
                                <template x-for="(points, value) in pointValueLookups[currentStat]" :key="value">
                                    <tr>
                                        <td x-text="value"></td>
                                        <td>
                                            <input type="number" 
                                                   x-model.number="pointValueLookups[currentStat][value]"
                                                   class="point-input">
                                        </td>
                                        <td>
                                            <span x-text="(pointValueLookups[currentStat][value] * statMultipliers[currentStat]).toFixed(1)" style="font-size: 0.9em;"></span>
                                        </td>
                                    </tr>
                                </template>
                            </table>
                        </div>

                        <!-- Weight Matrix Editor -->
                        <div class="weight-matrix-container" x-show="currentStat === 'weights'">
                            <h4>Stat Weight Matrix</h4>
                            <p class="matrix-info">This matrix defines how stats affect each other. Each row represents a source stat, and each column represents a target stat. The value at the intersection represents the influence of the source on the target.</p>
                            
                            <div class="weight-matrix-actions">
                                <button @click="saveWeightMatrix" class="save-weights-btn">Save Weight Matrix</button>
                                <button @click="resetWeightMatrix" class="reset-weights-btn">Reset to Default</button>
                                <button @click="includeWeightMatrixInExport = !includeWeightMatrixInExport" 
                                        class="toggle-weights-btn"
                                        x-bind:class="{'active': includeWeightMatrixInExport}">
                                    <span x-text="includeWeightMatrixInExport ? 'Included in Export' : 'Click to include in Export'"></span>
                                </button>
                            </div>
                            
                            <div class="weight-matrix-scroll">
                                <table class="weight-matrix-table">
                                    <thead>
                                        <tr>
                                            <th>Target Source</th>
                                            <template x-for="(statName, index) in Object.keys(statMultipliers)" :key="statName">
                                                <th class="tooltip" :data-tooltip="'Base cost multiplier for ' + formatStatName(statName)">
                                                    <div x-text="getStatShortName(statName)"></div>
                                                    <input type="number"
                                                           x-model.number="statMultipliers[statName]"
                                                           min="0"
                                                           step="0.1"
                                                           class="weight-input"
                                                           style="margin-top: 2px;"
                                                           @input="$nextTick(() => $forceUpdate())"
                                                           :style="{ backgroundColor: getMultiplierColor(statMultipliers[statName]) }">
                                                </th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="(weights, sourceStat) in statWeightMatrix" :key="sourceStat">
                                            <tr>
                                                <td x-text="getStatShortName(sourceStat)" class="weight-source-stat tooltip" :data-tooltip="'This row controls how much ' + formatStatName(sourceStat) + ' adds to the cost of each stat'"></td>
                                                <template x-for="(weight, i) in weights" :key="i">
                                                    <td>
                                                        <span class="tooltip" 
                                                              :data-tooltip="'model\'s ' + formatStatName(sourceStat) + ' ' + (statWeightMatrix[sourceStat][i] > 0 ? 'increases' : statWeightMatrix[sourceStat][i] < 0 ? 'decreases' : 'has no effect on') + ' cost of ' + formatStatName(getStatAtIndex(i))">
                                                            <input type="number" 
                                                                   x-model.number="statWeightMatrix[sourceStat][i]" 
                                                                   min="-2" 
                                                                   max="2" 
                                                                   step="0.1"
                                                                   class="weight-input"
                                                                   :class="{'active-weight': statWeightMatrix[sourceStat][i] > 0, 'negative-weight': statWeightMatrix[sourceStat][i] < 0}">
                                                        </span>
                                                    </td>
                                                </template>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>

                            <div class="weight-description">
                                <h5>Current Dependencies:</h5>
                                <ul class="dependency-list">
                                    <template x-for="(weights, sourceStat) in statWeightMatrix" :key="sourceStat">
                                        <template x-for="(weight, i) in weights" :key="i">
                                            <li x-show="weight != 0">
                                                <span x-text="formatStatName(sourceStat)"></span> 
                                                <span x-text="weight > 0 ? 'increases' : 'decreases'"></span> value of 
                                                <span x-text="formatStatName(getStatAtIndex(i))"></span> 
                                                with weight <span x-text="Math.abs(weight)"></span>
                                            </li>
                                        </template>
                                    </template>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-pane">
            <h2 class="hidden">Right Pane</h2>
            <p class="hidden">Content will go here.</p>
            <div class="point-formula-container hidden">
                <div class="point-formula-title">Point Value Tables</div>
                
                <div class="stat-selector">
                    <label for="stat-select">Select Stat:</label>
                    <select id="stat-select" x-model="currentStat" class="stat-select">
                        <option value="movement">Movement</option>
                        <option value="weaponSkill">Weapon Skill</option>
                        <option value="ballisticSkill">Ballistic Skill</option>
                        <option value="strength">Strength</option>
                        <option value="toughness">Toughness</option>
                        <option value="wounds">Wounds</option>
                        <option value="attacks">Attacks</option>
                        <option value="leadership">Leadership</option>
                        <option value="save">Save</option>
                        <option value="invulnSave">Invuln Save</option>
                        <option value="base">Base Cost</option>
                    </select>
                </div>
                
                <table class="point-formula-table">
                    <thead>
                        <tr>
                            <th>Stat</th>
                            <th>Values and Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Current Stat View -->
                        <template x-if="currentStat !== 'base'">
                            <tr>
                                <td x-text="formatStatName(currentStat)"></td>
                                <td>
                                    <template x-for="(points, value) in pointValueLookups[currentStat]" :key="value">
                                        <div class="point-value-row">
                                            <span x-text="`${value}: ${points >= 0 ? '+' : ''}${points}`"></span>
                                        </div>
                                    </template>
                                </td>
                            </tr>
                        </template>
                        
                        <!-- Base Cost -->
                        <template x-if="currentStat === 'base'">
                            <tr>
                                <td>Base Cost</td>
                                <td>10</td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add tooltip positioning script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.body.addEventListener('mouseover', function(e) {
                // Check if we're hovering over a tooltip element
                if (e.target.classList.contains('tooltip') || e.target.closest('.tooltip')) {
                    const tooltipEl = e.target.classList.contains('tooltip') ? e.target : e.target.closest('.tooltip');
                    
                    // Create a function to position the tooltip when it appears
                    tooltipEl.addEventListener('mouseenter', function() {
                        // Small delay to allow the pseudo-element to be created
                        setTimeout(() => {
                            // Get tooltip dimensions (have to use a hack for pseudo-elements)
                            // Add a temporary data attribute to identify this specific tooltip
                            const uniqueId = 'tooltip-' + Math.random().toString(36).substring(2);
                            tooltipEl.setAttribute('data-tooltip-id', uniqueId);
                            
                            // Get position of the tooltip element (not the cursor)
                            const rect = tooltipEl.getBoundingClientRect();
                            // Use the element's top and horizontal center for positioning
                            const tooltipTop = Math.max(rect.top - 40, 60); // Position above the element with minimum 60px from top
                            const tooltipLeft = rect.left + (rect.width / 2) - 70; // Center horizontally
                            
                            // Create a style element to get the pseudo-element
                            const style = document.createElement('style');
                            style.innerHTML = `
                                .tooltip[data-tooltip-id="${uniqueId}"]::after {
                                    top: ${tooltipTop}px !important; 
                                    left: ${tooltipLeft}px !important;
                                }
                            `;
                            document.head.appendChild(style);
                            
                            // Clean up after tooltip is no longer hovered
                            tooltipEl.addEventListener('mouseleave', function() {
                                document.head.removeChild(style);
                                tooltipEl.removeAttribute('data-tooltip-id');
                            }, { once: true });
                        }, 10);
                    });
                }
            }, true);
        });
    </script>
</body>
</html> 